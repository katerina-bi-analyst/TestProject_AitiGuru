
 1. Выручка по менеджерам (факт)

SELECT 
    r.[Менеджер],
    SUM(r.[Сумма продажи]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Выручка
FROM [Реализации (продажи)] r
LEFT JOIN [Возвраты] c ON r.[Артикул] = c.[Артикул]
GROUP BY r.[Менеджер];



 2. Маржа по менеджерам (факт)

SELECT 
    r.[Менеджер],
    SUM(o.[Маржа по артикулю]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Маржа
FROM [Заказы] o
LEFT JOIN [Возвраты] c ON o.[Артикул] = c.[Артикул]
GROUP BY r.[Менеджер];



 3. Средний чек по менеджерам

SELECT 
    r.[Менеджер],
    (SUM(r.[Сумма продажи]) - COALESCE(SUM(c.[Сумма возврата]),0)) 
      / COUNT(DISTINCT r.[Менеджер]) AS Средний чек
FROM [Реализации (продажи)] r
LEFT JOIN [Возвраты] c ON r.[Артикул] = c.[Артикул]
GROUP BY r.[Менеджер];



 4. Выручка по категориям товаров

SELECT 
    n.[Категория товара],
    SUM(r.[Сумма продажи]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Выручка
FROM [Реализации (продажи)] r
JOIN [Номенклатура] n ON r.[Артикул] = n.[Артикул]
LEFT JOIN [Возвраты] c ON r.[Артикул] = c.[Артикул]
GROUP BY n.[Категория товара];



 5. Выручка по конкретному артикулу

SELECT 
    r.[Артикул],
    SUM(r.[Сумма продажи]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Выручка
FROM [Реализации (продажи)] r
LEFT JOIN [Возвраты] c ON r.[Артикул] = c.[Артикул]
GROUP BY r.[Артикул];



 6. Плановые показатели по менеджерам

SELECT 
    [Менеджер], 
    SUM([План выручки]) AS План выручки, 
    SUM([Маржа]) AS План маржи
FROM [Плановые показатели по менеджер]
GROUP BY [Менеджер];



 7. Выручка / Маржа по команде (для руководителя)

SELECT 
    t.[Руководитель],
    SUM(r.[Сумма продажи]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Выручка,
    SUM(o.[Маржа по артикулю]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Маржа
FROM [Реализации (продажи)] r
JOIN [Команды] t ON r.[Менеджер] = t.[Участник]
LEFT JOIN [Возвраты] c ON r.[Артикул] = c.[Артикул]
LEFT JOIN [Заказы] o ON r.[Артикул] = o.[Артикул]
WHERE t.[Руководитель] IS NOT NULL
GROUP BY t.[Руководитель];



 8. План vs Факт по команде (для графика)

SELECT 
    t.[Руководитель],
    t.[Команда],
    SUM(p.[План выручки]) AS План Выручка,
    SUM(r.[Сумма продажи]) - COALESCE(SUM(c.[Сумма возврата]),0) AS Выручка
FROM [Команды] t
LEFT JOIN [Плановые показатели по менеджер] p ON t.[Участник] = p.[Менеджер]
LEFT JOIN [Реализации (продажи)] r ON t.[Участник] = r.[Менеджер]
LEFT JOIN [Возвраты] c ON r.[Артикул] = c.[Артикул]
WHERE t.[Руководитель] IS NOT NULL
GROUP BY t.[Руководитель], t.[Команда];
